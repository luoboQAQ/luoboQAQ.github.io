<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="记录红米AX6000使用Openwrt系统打造舒适上网环境"><title>红米AX6000折腾记</title><link rel=canonical href=https://lbqaq.top/p/ax6000/><link rel=stylesheet href=/scss/style.min.2d47bd8ef39ed3b6e381fc30c41c603c9773b1b9e311595afb8f0ffebf5b9437.css><meta property='og:title' content="红米AX6000折腾记"><meta property='og:description' content="记录红米AX6000使用Openwrt系统打造舒适上网环境"><meta property='og:url' content='https://lbqaq.top/p/ax6000/'><meta property='og:site_name' content='luoboQAQ'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='教程'><meta property='article:tag' content='路由器'><meta property='article:tag' content='openwrt'><meta property='article:published_time' content='2023-10-21T21:36:58+08:00'><meta property='article:modified_time' content='2023-11-22T13:24:00+08:00'><meta property='og:image' content='https://lbqaq.top/p/ax6000/112545261.webp'><meta name=twitter:title content="红米AX6000折腾记"><meta name=twitter:description content="记录红米AX6000使用Openwrt系统打造舒适上网环境"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://lbqaq.top/p/ax6000/112545261.webp'><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><style>:root{--sys-font-family:-apple-system, "LXGW WenKai", 'Microsoft Yahei', 'WenQuanYi Micro Hei', sans-serif;--code-font-family:"JetBrains Mono", "LXGW WenKai Mono", Menlo, Monaco, Consolas, monospace;--article-font-family:"LXGW WenKai", sans-serif;--base-font-family:"LXGW WenKai", var(--sys-font-family), sans-serif}</style><script type=text/javascript>(function(e,t,n,s,o,i,a){e[n]=e[n]||function(){(e[n].q=e[n].q||[]).push(arguments)},i=t.createElement(s),i.async=1,i.src="https://www.clarity.ms/tag/"+o,a=t.getElementsByTagName(s)[0],a.parentNode.insertBefore(i,a)})(window,document,"clarity","script","smhd51txrk")</script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/Mint_hu_90cbcbb19cfdb02a.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>🌞</span></figure><div class=site-meta><h1 class=site-name><a href=/>luoboQAQ</a></h1><h2 class=site-description>快乐学习每一天</h2></div></header><ol class=menu-social><li><a href=https://github.com/luoboQAQ target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://lbqaq.top/index.xml target=_blank title=RSS订阅 rel=me><svg class="icon icon-tabler icon-tabler-rss" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="5" cy="19" r="1"/><path d="M4 4a16 16 0 0116 16"/><path d="M4 11a9 9 0 019 9"/></svg></a></li><li><a href=https://pan.lbqaq.top target=_blank title=我的个人云盘 rel=me><svg class="icon icon-tabler icon-tabler-cloud" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="#2c3e50" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 18a4.6 4.4.0 010-9 5 4.5.0 0111 2h1a3.5 3.5.0 010 7H7"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>主页</span></a></li><li><a href=/about/><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>关于</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>文章</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>查询</span></a></li><li><a href=/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>友链</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>暗色模式</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#起因>起因</a></li><li><a href=#成果>成果</a></li><li><a href=#配置>配置</a><ol><li><a href=#解锁与刷机>解锁与刷机</a></li><li><a href=#刷入uboot>刷入uboot</a></li><li><a href=#配置校园网自动连接>配置校园网自动连接</a></li><li><a href=#配置ipv6>配置ipv6</a></li><li><a href=#配置mosdns>配置mosdns</a></li><li><a href=#配置wireguard>配置Wireguard</a></li><li><a href=#配置ddns>配置ddns</a></li></ol></li><li><a href=#小结>小结</a></li><li><a href=#更新日志>更新日志</a></li><li><a href=#参考文献>参考文献</a></li></ol></nav></div></section></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/p/ax6000/><img src=/p/ax6000/112545261.webp width=2000 height=1321 loading=lazy alt="Featured image of post 红米AX6000折腾记"></a></div><div class=article-details><header class=article-category><a href=/categories/%E7%BD%91%E7%BB%9C/>网络</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/ax6000/>红米AX6000折腾记</a></h2><h3 class=article-subtitle>记录红米AX6000使用Openwrt系统打造舒适上网环境</h3></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>2023-10-21</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>阅读时长: 13 分钟</time></div></footer></div></header><section class=article-content><h2 id=起因><a href=#%e8%b5%b7%e5%9b%a0 class=header-anchor></a>起因</h2><p>由于实验室的网线口过于稀少且离我距离太远，学校的WIFI又是WIFI5，平时最多只能跑到30MB/s。但我的笔记本支持WIFi6，学校又是千兆网。两条原因一叠加，那就直接上WIFI6的路由器吧。首要的选择条件就是支持刷机，在恩山上逛了一阵子，就决定入手红米的AX6000。可解锁、有第三方固件、512MB内存。特别是这512MB内存，比起我之前用的红米AC2100，直接翻了4倍，相较于原来随便开个插件就没有内存的情况，直接起飞好吧😎。</p><h2 id=成果><a href=#%e6%88%90%e6%9e%9c class=header-anchor></a>成果</h2><p>先来一手倒序(毕竟配置的过程比较无聊😇。使用南京大学测速站进行测试，可以看到网速直接拉满，下载东西的时候终于不用等那么久了。</p><p><img src=/p/ax6000/IMAGE/image-20231021190205506.png width=564 height=335 srcset="/p/ax6000/IMAGE/image-20231021190205506_hu_6915e9da78c79fac.png 480w, /p/ax6000/IMAGE/image-20231021190205506_hu_119274955b3a2e6a.png 1024w" loading=lazy alt=学校WIFI测试 class=gallery-image data-flex-grow=168 data-flex-basis=404px> <img src=/p/ax6000/IMAGE/image-20231021190046644.png width=641 height=351 srcset="/p/ax6000/IMAGE/image-20231021190046644_hu_61ee69c866462efa.png 480w, /p/ax6000/IMAGE/image-20231021190046644_hu_890f3f4025fa58ea.png 1024w" loading=lazy alt=AX6000测速 class=gallery-image data-flex-grow=182 data-flex-basis=438px></p><p>再加上各种插件，真的很舒适🤤，上网体验直接拉满。下面就是将相关的配置过程做个记录。</p><h2 id=配置><a href=#%e9%85%8d%e7%bd%ae class=header-anchor></a>配置</h2><h3 id=解锁与刷机><a href=#%e8%a7%a3%e9%94%81%e4%b8%8e%e5%88%b7%e6%9c%ba class=header-anchor></a>解锁与刷机</h3><p>这里可以参考B站大佬的视频<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>，步骤非常详细，直接跟着做就好了。为了备忘，我这里再简单把步骤写一下。</p><p>高版本的系统已经封堵了解锁的漏洞，我们要做的第一步就是使用小米修复工具进行降级。</p><p>之后进入管理界面并登录，此时地址格式类似下面这样：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plain data-lang=plain><span class=line><span class=cl>http://192.168.31.15/cgi-bin/luci/;stok=030b24d39b1a4a549aa12dac23c52313/web/home#router
</span></span></code></pre></td></tr></table></div></div><p>我们将<code>/web/home#router</code>删除，并加上下面一段：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plain data-lang=plain><span class=line><span class=cl>/api/misystem/set_sys_time?timezone=%20%27%20%3B%20zz%3D%24%28dd%20if%3D%2Fdev%2Fzero%20bs%3D1%20count%3D2%202%3E%2Fdev%2Fnull%29%20%3B%20printf%20%27%A5%5A%25c%25c%27%20%24zz%20%24zz%20%7C%20mtd%20write%20-%20crash%20%3B%20
</span></span></code></pre></td></tr></table></div></div><p>即连接应该为<code>http://192.168.31.15/cgi-bin/luci/;stok=030b24d39b1a4a549aa12dac23c52313/api/......</code></p><p>回车访问，显示<code>{"code":0}</code>表示成功</p><p>同理，继续替换：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plain data-lang=plain><span class=line><span class=cl>/api/misystem/set_sys_time?timezone=%20%27%20%3b%20reboot%20%3b%20
</span></span></code></pre></td></tr></table></div></div><p>等待重启完成</p><p>登录路由器，替换：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plain data-lang=plain><span class=line><span class=cl>/api/misystem/set_sys_time?timezone=%20%27%20%3B%20bdata%20set%20telnet_en%3D1%20%3B%20bdata%20set%20ssh_en%3D1%20%3B%20bdata%20set%20uart_en%3D1%20%3B%20bdata%20commit%20%3B%20
</span></span></code></pre></td></tr></table></div></div><p>继续替换：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plain data-lang=plain><span class=line><span class=cl>/api/misystem/set_sys_time?timezone=%20%27%20%3b%20reboot%20%3b%20
</span></span></code></pre></td></tr></table></div></div><p>等待重启完成</p><p>此时<code>telnet</code>已经开启，连接进入，显示【ARE U OK】的界面，表示telnet成功。</p><p>输入下面的命令开启<code>ssh</code>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>bdata <span class=nb>set</span> <span class=nv>boot_wait</span><span class=o>=</span>on
</span></span><span class=line><span class=cl>bdata commit
</span></span><span class=line><span class=cl>nvram <span class=nb>set</span> <span class=nv>ssh_en</span><span class=o>=</span><span class=m>1</span>
</span></span><span class=line><span class=cl>nvram <span class=nb>set</span> <span class=nv>telnet_en</span><span class=o>=</span><span class=m>1</span>
</span></span><span class=line><span class=cl>nvram <span class=nb>set</span> <span class=nv>uart_en</span><span class=o>=</span><span class=m>1</span>
</span></span><span class=line><span class=cl>nvram <span class=nb>set</span> <span class=nv>boot_wait</span><span class=o>=</span>on
</span></span><span class=line><span class=cl>nvram commit
</span></span><span class=line><span class=cl>sed -i <span class=s1>&#39;s/channel=.*/channel=&#34;debug&#34;/g&#39;</span> /etc/init.d/dropbear
</span></span><span class=line><span class=cl>/etc/init.d/dropbear restart
</span></span><span class=line><span class=cl><span class=nb>echo</span> -e <span class=s1>&#39;admin\nadmin&#39;</span> <span class=p>|</span> passwd root
</span></span></code></pre></td></tr></table></div></div><p>继续输入下面的命令，关闭开发者模式：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>mtd erase crash
</span></span></code></pre></td></tr></table></div></div><p>使用ssh连接进入，将<code>xwrt</code>目录里的<code>stock-initramfs-factory.ubi</code>传入<code>tmp</code>目录</p><p>输入下面的命令查看系统分区</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>cat /proc/cmdline
</span></span></code></pre></td></tr></table></div></div><p>输出类似这样：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plain data-lang=plain><span class=line><span class=cl>console=ttyS0,115200n1 loglevel=8 firmware=1 uart_en=1
</span></span></code></pre></td></tr></table></div></div><p>我们主要关注<code>firmware=1</code>这项</p><p>如firmware=0输入</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>nvram <span class=nb>set</span> <span class=nv>boot_wait</span><span class=o>=</span>on
</span></span><span class=line><span class=cl>nvram <span class=nb>set</span> <span class=nv>uart_en</span><span class=o>=</span><span class=m>1</span>
</span></span><span class=line><span class=cl>nvram <span class=nb>set</span> <span class=nv>flag_boot_rootfs</span><span class=o>=</span><span class=m>1</span>
</span></span><span class=line><span class=cl>nvram <span class=nb>set</span> <span class=nv>flag_last_success</span><span class=o>=</span><span class=m>1</span>
</span></span><span class=line><span class=cl>nvram <span class=nb>set</span> <span class=nv>flag_boot_success</span><span class=o>=</span><span class=m>1</span>
</span></span><span class=line><span class=cl>nvram <span class=nb>set</span> <span class=nv>flag_try_sys1_failed</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>nvram <span class=nb>set</span> <span class=nv>flag_try_sys2_failed</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>nvram commit
</span></span></code></pre></td></tr></table></div></div><p>然后刷入固件</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>ubiformat /dev/mtd9 -y -f /tmp/stock-initramfs-factory.ubi
</span></span></code></pre></td></tr></table></div></div><p>如firmware=1输入</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>nvram <span class=nb>set</span> <span class=nv>boot_wait</span><span class=o>=</span>on
</span></span><span class=line><span class=cl>nvram <span class=nb>set</span> <span class=nv>uart_en</span><span class=o>=</span><span class=m>1</span>
</span></span><span class=line><span class=cl>nvram <span class=nb>set</span> <span class=nv>flag_boot_rootfs</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>nvram <span class=nb>set</span> <span class=nv>flag_last_success</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>nvram <span class=nb>set</span> <span class=nv>flag_boot_success</span><span class=o>=</span><span class=m>1</span>
</span></span><span class=line><span class=cl>nvram <span class=nb>set</span> <span class=nv>flag_try_sys1_failed</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>nvram <span class=nb>set</span> <span class=nv>flag_try_sys2_failed</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>nvram commit
</span></span></code></pre></td></tr></table></div></div><p>然后刷入固件</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>ubiformat /dev/mtd8 -y -f /tmp/stock-initramfs-factory.ubi
</span></span></code></pre></td></tr></table></div></div><p>reboot重启 固件后台：http://192.168.15.1/ 账户密码：admin/admin 在后台升级xwrt正式固件</p><p>进入xwrt正式固件后台—系统—管理权—ssh访问—打开密码验证和允许root用户凭密码登录-保存并应用。 再次连接SSH（ip192.168.15.1用户名root密码admin），输入以下命令</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>fw_setenv boot_wait on
</span></span><span class=line><span class=cl>fw_setenv uart_en <span class=m>1</span>
</span></span><span class=line><span class=cl>fw_setenv flag_boot_rootfs <span class=m>0</span>
</span></span><span class=line><span class=cl>fw_setenv flag_last_success <span class=m>1</span>
</span></span><span class=line><span class=cl>fw_setenv flag_boot_success <span class=m>1</span>
</span></span><span class=line><span class=cl>fw_setenv flag_try_sys1_failed <span class=m>8</span>
</span></span><span class=line><span class=cl>fw_setenv flag_try_sys2_failed <span class=m>8</span>
</span></span></code></pre></td></tr></table></div></div><p>之后刷入最新237大佬固件</p><h3 id=刷入uboot><a href=#%e5%88%b7%e5%85%a5uboot class=header-anchor></a>刷入uboot</h3><p>之前刷入的官方版的镜像，虽然很方便，但是可用空间并不是很多，为了榨干它全部的性能，我还是决定刷入第三方uboot，将官方原始的三个分区合并成一个大分区。</p><p>我这里刷入的hanwckf大佬制作的uboot，他支持多分区的切换，还是很方便的。具体的功能和下载链接可以看大佬的博客——<a class=link href=https://cmi.hanwckf.top/p/mt798x-uboot-usage/ target=_blank rel=noopener>mt798x uboot 功能介绍</a>。</p><p>我们之前刷入过237大佬的固件了，所以FIP分区已经解锁，可以直接刷。</p><p>首先要<strong>备份</strong>原始的分区，像Factory为无线EEPROM分区；Bdata存储着你的SN和MAC。如果没了应该是无法使用别人的分区来使用的。所以一定要备份好。</p><p>我们使用dd命令备份分区到tmp文件夹：<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>dd <span class=k>if</span><span class=o>=</span>/dev/mtd1 <span class=nv>of</span><span class=o>=</span>/tmp/mtd1_BL2.bin
</span></span><span class=line><span class=cl>dd <span class=k>if</span><span class=o>=</span>/dev/mtd2 <span class=nv>of</span><span class=o>=</span>/tmp/mtd2_Nvram.bin
</span></span><span class=line><span class=cl>dd <span class=k>if</span><span class=o>=</span>/dev/mtd3 <span class=nv>of</span><span class=o>=</span>/tmp/mtd3_Bdata.bin
</span></span><span class=line><span class=cl>dd <span class=k>if</span><span class=o>=</span>/dev/mtd4 <span class=nv>of</span><span class=o>=</span>/tmp/mtd4_Factory.bin
</span></span><span class=line><span class=cl>dd <span class=k>if</span><span class=o>=</span>/dev/mtd5 <span class=nv>of</span><span class=o>=</span>/tmp/mtd5_FIP.bin
</span></span></code></pre></td></tr></table></div></div><p>然后使用WinSCP等软件将备份的文件下载到电脑上。</p><p>备份好后，就可以通过WinSCP将uboot文件上传到tmp目录下，并执行下面的命令进行刷入：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>d5sum /tmp/mt7986_redmi_ax6000-fip-fixed-parts-multi-layout.bin
</span></span><span class=line><span class=cl>mtd write /tmp/mt7986_redmi_ax6000-fip-fixed-parts-multi-layout.bin FIP
</span></span><span class=line><span class=cl>mtd verify /tmp/mt7986_redmi_ax6000-fip-fixed-parts-multi-layout.bin FIP
</span></span></code></pre></td></tr></table></div></div><p>注意对比md5的值是否一致。最后如果成功则会输出<code>Success</code></p><p>将路由器断电，按住Reset键并通电，持续按住10S即可进入uboot了。</p><p>由于H大的uboot没有配置DHCP，我们需要手动配置电脑ip：</p><ul><li>IP地址：192.168.31.100</li><li>子网掩码：255.255.255.0</li><li>默认网关：192.168.31.1</li><li>DNS：192.168.31.1</li></ul><p>访问192.168.31.1即可进入uboot页面，这时就可以刷入大分区的固件了</p><h3 id=配置校园网自动连接><a href=#%e9%85%8d%e7%bd%ae%e6%a0%a1%e5%9b%ad%e7%bd%91%e8%87%aa%e5%8a%a8%e8%bf%9e%e6%8e%a5 class=header-anchor></a>配置校园网自动连接</h3><p>在我之前，已经有大佬针对校园网的登录写了自动化脚本</p><div class=github><div class=logo><svg class="icon github-icon" viewBox="0 0 16 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M2 2.5c0-.66304.26339-1.29893.73223-1.767767C3.20108.263392 3.83696.0 4.5.0h8.75c.1989.0.3897.0790176.5303.21967C13.921.360322 14 .551088 14 .75v12.5C14 13.4489 13.921 13.6397 13.7803 13.7803 13.6397 13.921 13.4489 14 13.25 14h-2.5C10.5511 14 10.3603 13.921 10.2197 13.7803 10.079 13.6397 10 13.4489 10 13.25S10.079 12.8603 10.2197 12.7197C10.3603 12.579 10.5511 12.5 10.75 12.5H12.5v-2h-8C4.30308 10.5 4.11056 10.5582 3.94657 10.6672 3.78257 10.7762 3.65442 10.9312 3.57816 11.1128 3.50191 11.2943 3.48096 11.4943 3.51793 11.6878 3.5549 11.8812 3.64816 12.0594 3.786 12.2c.13924.142200000000001.2163.3338.21424.5328C3.99818 12.9318 3.91716 13.1218 3.775 13.261 3.63285 13.4002 3.4412 13.4773 3.24222 13.4752 3.04325 13.4732 2.85324 13.3922 2.714 13.25c-.45829-.4671-.71471-1.0956-.714-1.75v-9zm10.5-1V9h-8C4.144 9 3.806 9.074 3.5 9.208V2.5c0-.26522.10536-.51957.29289-.70711C3.98043 1.60536 4.23478 1.5 4.5 1.5h8zM5 12.25V15.5C5 15.5464 5.01293 15.5919 5.03734 15.6314 5.06175 15.6709 5.09667 15.7028 5.1382 15.7236 5.17972 15.7444 5.22621 15.7532 5.27245 15.749 5.31869 15.7448 5.36286 15.7279 5.4 15.7l1.45-1.087C6.89328 14.5805 6.94591 14.563 7 14.563S7.10673 14.5805 7.15 14.613L8.6 15.7C8.63714 15.7279 8.68131 15.7448 8.72755 15.749 8.77379 15.7532 8.82028 15.7444 8.8618 15.7236 8.90333 15.7028 8.93826 15.6709 8.96266 15.6314 8.98707 15.5919 9 15.5464 9 15.5V12.25C9 12.1837 8.97366 12.1201 8.92678 12.0732 8.87989 12.0263 8.81631 12 8.75 12H5.25C5.1837 12 5.12011 12.0263 5.07322 12.0732 5.02634 12.1201 5 12.1837 5 12.25z"/></svg>
<a class=name href=https://github.com/TerraceCN/yzu-campusnet-login target=_blank>yzu-campusnet-login</a></div><div class=visibility>public</div><div class=description>校园网登录器</div><div class=language><span class=language-color style=background-color:#3572a5></span>
<span class=language-name>Python</span></div></div><p>然而，这并不适用我的环境。由于红米AX6000的官方布局采用了A/B分区，导致可用的软件包分区只有20多MB。在这么小的空间中安装个Python，再加上各种各样的库，想想就可怕。</p><p>为此，我需要使用一门可以打包成小体积的语言来重构此程序。一开始，我想选择C++，但是C++的网络编程我还没了解过，正在我思考要不要花些时间学习一下，突然想到了有一门语言完美符合我的需求——Golang。跨平台、有方便的网络库，于是我便花了一天时间学习Go，成功将大佬的程序重构了（正好当学习Go语言的练手程序。</p><div class=github><div class=logo><svg class="icon github-icon" viewBox="0 0 16 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M2 2.5c0-.66304.26339-1.29893.73223-1.767767C3.20108.263392 3.83696.0 4.5.0h8.75c.1989.0.3897.0790176.5303.21967C13.921.360322 14 .551088 14 .75v12.5C14 13.4489 13.921 13.6397 13.7803 13.7803 13.6397 13.921 13.4489 14 13.25 14h-2.5C10.5511 14 10.3603 13.921 10.2197 13.7803 10.079 13.6397 10 13.4489 10 13.25S10.079 12.8603 10.2197 12.7197C10.3603 12.579 10.5511 12.5 10.75 12.5H12.5v-2h-8C4.30308 10.5 4.11056 10.5582 3.94657 10.6672 3.78257 10.7762 3.65442 10.9312 3.57816 11.1128 3.50191 11.2943 3.48096 11.4943 3.51793 11.6878 3.5549 11.8812 3.64816 12.0594 3.786 12.2c.13924.142200000000001.2163.3338.21424.5328C3.99818 12.9318 3.91716 13.1218 3.775 13.261 3.63285 13.4002 3.4412 13.4773 3.24222 13.4752 3.04325 13.4732 2.85324 13.3922 2.714 13.25c-.45829-.4671-.71471-1.0956-.714-1.75v-9zm10.5-1V9h-8C4.144 9 3.806 9.074 3.5 9.208V2.5c0-.26522.10536-.51957.29289-.70711C3.98043 1.60536 4.23478 1.5 4.5 1.5h8zM5 12.25V15.5C5 15.5464 5.01293 15.5919 5.03734 15.6314 5.06175 15.6709 5.09667 15.7028 5.1382 15.7236 5.17972 15.7444 5.22621 15.7532 5.27245 15.749 5.31869 15.7448 5.36286 15.7279 5.4 15.7l1.45-1.087C6.89328 14.5805 6.94591 14.563 7 14.563S7.10673 14.5805 7.15 14.613L8.6 15.7C8.63714 15.7279 8.68131 15.7448 8.72755 15.749 8.77379 15.7532 8.82028 15.7444 8.8618 15.7236 8.90333 15.7028 8.93826 15.6709 8.96266 15.6314 8.98707 15.5919 9 15.5464 9 15.5V12.25C9 12.1837 8.97366 12.1201 8.92678 12.0732 8.87989 12.0263 8.81631 12 8.75 12H5.25C5.1837 12 5.12011 12.0263 5.07322 12.0732 5.02634 12.1201 5 12.1837 5 12.25z"/></svg>
<a class=name href=https://github.com/luoboQAQ/yzu-campusnet-login target=_blank>yzu-campusnet-login</a></div><div class=visibility>public</div><div class=description>Go版本的校园网登录器</div><div class=language><span class=language-color style=background-color:#00add8></span>
<span class=language-name>Go</span></div></div><p>直接将编译好的二进制文件传入到路由器中，并写好配置文件，之后在后台——“系统”——“启动项”下面的本地启动脚本添加一条运行命令就可以开机启动了。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=nb>cd</span> /root/login <span class=o>&amp;&amp;</span> nohup ./YzuCampusnetLogin &gt; /tmp/login.log 2&gt;<span class=p>&amp;</span><span class=m>1</span> <span class=p>&amp;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=配置ipv6><a href=#%e9%85%8d%e7%bd%aeipv6 class=header-anchor></a>配置ipv6</h3><p>学校的ipv6下发的是/64地址，一开始我参考<a class=link href=https://wjk.moe/2022/%E9%94%90%E6%8D%B7%E6%A0%A1%E5%9B%AD%E7%BD%91IPv6%E7%9A%84%EF%BC%8F64%E5%86%85%E7%BD%91%E4%B8%AD%E7%BB%A7%E9%85%8D%E7%BD%AE%EF%BC%9Andp-proxy%E3%80%81relay/ target=_blank rel=noopener>这个大佬的教程</a>，使用内网中继的方案来实现ipv6。然而无论我怎么配置，都无法连接互联网。最后发现是学校网关对每一个ipv6地址都会进行登录的校验，如果没有登录就不会放行，那这条路算是彻底堵死了😥。</p><p>这样的话，就只能使用nat6了,详细的步骤可以参考这篇教程<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup></p><p>将接口——LAN——IPV6设置中的路由通告服务选为“服务器模式”、DHCPv6 服务选为“服务器模式”、NDP 代理选为“禁用”、DHCPv6 模式选为“无状态的 + 有状态的”、总是通告默认路由勾上</p><p>使用ssh连接路由器，在<code>/etc/init.d</code>目录下新建<code>nat6</code>并填入下面的内容：</p><details><summary>📃展开代码</summary><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span><span class=lnt>92
</span><span class=lnt>93
</span><span class=lnt>94
</span><span class=lnt>95
</span><span class=lnt>96
</span><span class=lnt>97
</span><span class=lnt>98
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=cp>#!/bin/sh /etc/rc.common
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=c1># NAT6 init script for OpenWrt // Depends on package: kmod-ipt-nat6</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># edited by Sad Pencil at 2020-02-09</span>
</span></span><span class=line><span class=cl><span class=c1># replace route command with ip command to solve issues on new OpenWRT</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># edited by Sad Pencil at 2021-11-29</span>
</span></span><span class=line><span class=cl><span class=c1># update line WAN6_INTERFACE=$(uci get &#34;network.$WAN6_NAME.device&#34; || uci get &#34;network.$WAN6_NAME.ifname&#34;)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>START</span><span class=o>=</span><span class=m>55</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Options</span>
</span></span><span class=line><span class=cl><span class=c1># -------</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Use temporary addresses (IPv6 privacy extensions) for outgoing connections? Yes: 1 / No: 0</span>
</span></span><span class=line><span class=cl><span class=nv>PRIVACY</span><span class=o>=</span><span class=m>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Maximum number of attempts before this script will stop in case no IPv6 route is available</span>
</span></span><span class=line><span class=cl><span class=c1># This limits the execution time of the IPv6 route lookup to (MAX_TRIES+1)*(MAX_TRIES/2) seconds. The default (15) equals 120 seconds.</span>
</span></span><span class=line><span class=cl><span class=nv>MAX_TRIES</span><span class=o>=</span><span class=m>15</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># An initial delay (in seconds) helps to avoid looking for the IPv6 network too early. Ideally, the first probe is successful.</span>
</span></span><span class=line><span class=cl><span class=c1># This would be the case if the time passed between the system log messages &#34;Probing IPv6 route&#34; and &#34;Setting up NAT6&#34; is 1 second.</span>
</span></span><span class=line><span class=cl><span class=nv>DELAY</span><span class=o>=</span><span class=m>5</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Logical interface name of outbound IPv6 connection</span>
</span></span><span class=line><span class=cl><span class=c1># There should be no need to modify this, unless you changed the default network interface names</span>
</span></span><span class=line><span class=cl><span class=c1># Edit by Vincent: I never changed my default network interface names, but still I have to change the WAN6_NAME to &#34;wan&#34; instead of &#34;wan6&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>WAN6_NAME</span><span class=o>=</span><span class=s2>&#34;wan6&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ---------------------------------------------------</span>
</span></span><span class=line><span class=cl><span class=c1># Options end here - no need to change anything below</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>boot<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>[</span> <span class=nv>$DELAY</span> -gt <span class=m>0</span> <span class=o>]</span> <span class=o>&amp;&amp;</span> sleep <span class=nv>$DELAY</span>
</span></span><span class=line><span class=cl>        <span class=nv>WAN6_INTERFACE</span><span class=o>=</span><span class=k>$(</span>uci get <span class=s2>&#34;network.</span><span class=nv>$WAN6_NAME</span><span class=s2>.ifname&#34;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>        logger -t NAT6 <span class=s2>&#34;Probing IPv6 route&#34;</span>
</span></span><span class=line><span class=cl>        <span class=nv>PROBE</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>        <span class=nv>COUNT</span><span class=o>=</span><span class=m>1</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=o>[</span> <span class=nv>$PROBE</span> -eq <span class=m>0</span> <span class=o>]</span>
</span></span><span class=line><span class=cl>        <span class=k>do</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>[</span> <span class=nv>$COUNT</span> -gt <span class=nv>$MAX_TRIES</span> <span class=o>]</span>
</span></span><span class=line><span class=cl>                <span class=k>then</span>
</span></span><span class=line><span class=cl>                        logger -t NAT6 <span class=s2>&#34;Fatal error: No IPv6 route found (reached retry limit)&#34;</span> <span class=o>&amp;&amp;</span> <span class=nb>exit</span> <span class=m>1</span>
</span></span><span class=line><span class=cl>                <span class=k>fi</span>
</span></span><span class=line><span class=cl>                sleep <span class=nv>$COUNT</span>
</span></span><span class=line><span class=cl>                <span class=nv>COUNT</span><span class=o>=</span><span class=k>$((</span>COUNT+1<span class=k>))</span>
</span></span><span class=line><span class=cl>                <span class=nv>PROBE</span><span class=o>=</span><span class=k>$(</span>ip -6 route <span class=p>|</span> grep -i <span class=s1>&#39;^default.*via&#39;</span> <span class=p>|</span> grep -i -F <span class=s2>&#34;dev </span><span class=nv>$WAN6_INTERFACE</span><span class=s2>&#34;</span> <span class=p>|</span> grep -i -o <span class=s1>&#39;via.*&#39;</span> <span class=p>|</span> wc -l<span class=k>)</span>
</span></span><span class=line><span class=cl>        <span class=k>done</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        logger -t NAT6 <span class=s2>&#34;Setting up NAT6&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>[</span> -z <span class=s2>&#34;</span><span class=nv>$WAN6_INTERFACE</span><span class=s2>&#34;</span> <span class=o>]</span> <span class=o>||</span> <span class=o>[</span> ! -e <span class=s2>&#34;/sys/class/net/</span><span class=nv>$WAN6_INTERFACE</span><span class=s2>/&#34;</span> <span class=o>]</span> <span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>                logger -t NAT6 <span class=s2>&#34;Fatal error: Lookup of </span><span class=nv>$WAN6_NAME</span><span class=s2> interface failed. Were the default interface names changed?&#34;</span> <span class=o>&amp;&amp;</span> <span class=nb>exit</span> <span class=m>1</span>
</span></span><span class=line><span class=cl>        <span class=k>fi</span>
</span></span><span class=line><span class=cl>        <span class=c1>#WAN6_GATEWAY=$(ip -6 route | grep -o &#39;2001.*1102&#39; | sed s&#39;/1102/1101::1/g&#39;)</span>
</span></span><span class=line><span class=cl>        <span class=nv>WAN6_GATEWAY</span><span class=o>=</span><span class=k>$(</span>ip -6 route <span class=p>|</span> grep -i <span class=s1>&#39;^default.*via&#39;</span> <span class=p>|</span> grep -i -F <span class=s2>&#34;dev </span><span class=nv>$WAN6_INTERFACE</span><span class=s2>&#34;</span> <span class=p>|</span> grep -i -o <span class=s1>&#39;via.*&#39;</span> <span class=p>|</span> cut -d <span class=s1>&#39; &#39;</span> -f <span class=m>2</span> <span class=p>|</span> head -n 1<span class=k>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>[</span> -z <span class=s2>&#34;</span><span class=nv>$WAN6_GATEWAY</span><span class=s2>&#34;</span> <span class=o>]</span> <span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>                logger -t NAT6 <span class=s2>&#34;Fatal error: No IPv6 gateway for </span><span class=nv>$WAN6_INTERFACE</span><span class=s2> found&#34;</span> <span class=o>&amp;&amp;</span> <span class=nb>exit</span> <span class=m>1</span>
</span></span><span class=line><span class=cl>        <span class=k>fi</span>
</span></span><span class=line><span class=cl>        <span class=nv>LAN_ULA_PREFIX</span><span class=o>=</span><span class=k>$(</span>uci get network.globals.ula_prefix<span class=k>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>[</span> <span class=k>$(</span><span class=nb>echo</span> <span class=s2>&#34;</span><span class=nv>$LAN_ULA_PREFIX</span><span class=s2>&#34;</span> <span class=p>|</span> grep -c -E <span class=s2>&#34;^([0-9a-fA-F]{4}):([0-9a-fA-F]{0,4}):&#34;</span><span class=k>)</span> -ne <span class=m>1</span> <span class=o>]</span> <span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>                logger -t NAT6 <span class=s2>&#34;Fatal error: IPv6 ULA prefix </span><span class=nv>$LAN_ULA_PREFIX</span><span class=s2> seems invalid. Please verify that a prefix is set and valid.&#34;</span> <span class=o>&amp;&amp;</span> <span class=nb>exit</span> <span class=m>1</span>
</span></span><span class=line><span class=cl>        <span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        ip6tables -t nat -I POSTROUTING -s <span class=s2>&#34;</span><span class=nv>$LAN_ULA_PREFIX</span><span class=s2>&#34;</span> -o <span class=s2>&#34;</span><span class=nv>$WAN6_INTERFACE</span><span class=s2>&#34;</span> -j MASQUERADE
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>[</span> <span class=nv>$?</span> -eq <span class=m>0</span> <span class=o>]</span> <span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>                logger -t NAT6 <span class=s2>&#34;Added IPv6 masquerading rule to the firewall (Src: </span><span class=nv>$LAN_ULA_PREFIX</span><span class=s2> - Dst: </span><span class=nv>$WAN6_INTERFACE</span><span class=s2>)&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span>
</span></span><span class=line><span class=cl>                logger -t NAT6 <span class=s2>&#34;Fatal error: Failed to add IPv6 masquerading rule to the firewall (Src: </span><span class=nv>$LAN_ULA_PREFIX</span><span class=s2> - Dst: </span><span class=nv>$WAN6_INTERFACE</span><span class=s2>)&#34;</span> <span class=o>&amp;&amp;</span> <span class=nb>exit</span> <span class=m>1</span>
</span></span><span class=line><span class=cl>        <span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        ip -6 route add 2000::/3 via <span class=s2>&#34;</span><span class=nv>$WAN6_GATEWAY</span><span class=s2>&#34;</span> dev <span class=s2>&#34;</span><span class=nv>$WAN6_INTERFACE</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>[</span> <span class=nv>$?</span> -eq <span class=m>0</span> <span class=o>]</span> <span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>                logger -t NAT6 <span class=s2>&#34;Added </span><span class=nv>$WAN6_GATEWAY</span><span class=s2> to routing table as gateway on </span><span class=nv>$WAN6_INTERFACE</span><span class=s2> for outgoing connections&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span>
</span></span><span class=line><span class=cl>                logger -t NAT6 <span class=s2>&#34;Error: Failed to add </span><span class=nv>$WAN6_GATEWAY</span><span class=s2> to routing table as gateway on </span><span class=nv>$WAN6_INTERFACE</span><span class=s2> for outgoing connections&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>[</span> <span class=nv>$PRIVACY</span> -eq <span class=m>1</span> <span class=o>]</span> <span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>                <span class=nb>echo</span> <span class=m>2</span> &gt; <span class=s2>&#34;/proc/sys/net/ipv6/conf/</span><span class=nv>$WAN6_INTERFACE</span><span class=s2>/accept_ra&#34;</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>[</span> <span class=nv>$?</span> -eq <span class=m>0</span> <span class=o>]</span> <span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>                        logger -t NAT6 <span class=s2>&#34;Accepting router advertisements on </span><span class=nv>$WAN6_INTERFACE</span><span class=s2> even if forwarding is enabled (required for temporary addresses)&#34;</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span>
</span></span><span class=line><span class=cl>                        logger -t NAT6 <span class=s2>&#34;Error: Failed to change router advertisements accept policy on </span><span class=nv>$WAN6_INTERFACE</span><span class=s2> (required for temporary addresses)&#34;</span>
</span></span><span class=line><span class=cl>                <span class=k>fi</span>
</span></span><span class=line><span class=cl>                <span class=nb>echo</span> <span class=m>2</span> &gt; <span class=s2>&#34;/proc/sys/net/ipv6/conf/</span><span class=nv>$WAN6_INTERFACE</span><span class=s2>/use_tempaddr&#34;</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>[</span> <span class=nv>$?</span> -eq <span class=m>0</span> <span class=o>]</span> <span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>                        logger -t NAT6 <span class=s2>&#34;Using temporary addresses for outgoing connections on interface </span><span class=nv>$WAN6_INTERFACE</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span>
</span></span><span class=line><span class=cl>                        logger -t NAT6 <span class=s2>&#34;Error: Failed to enable temporary addresses for outgoing connections on interface </span><span class=nv>$WAN6_INTERFACE</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>                <span class=k>fi</span>
</span></span><span class=line><span class=cl>        <span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nb>exit</span> <span class=m>0</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div></details><p>执行下面的命令，使脚本开机运行：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>chmod +x /etc/init.d/nat6
</span></span><span class=line><span class=cl>/etc/init.d/nat6 <span class=nb>enable</span>
</span></span></code></pre></td></tr></table></div></div><p>修改<code>/etc/sysctl.conf</code>，添加下面的内容：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>net.ipv6.conf.default.forwarding=2
</span></span><span class=line><span class=cl>net.ipv6.conf.all.forwarding=2
</span></span><span class=line><span class=cl>net.ipv6.conf.default.accept_ra=2
</span></span><span class=line><span class=cl>net.ipv6.conf.all.accept_ra=2
</span></span></code></pre></td></tr></table></div></div><p>最后在自定义防火墙中添加一行命令：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>ip6tables -t nat -A POSTROUTING -o <span class=k>$(</span>uci get network.wan6.ifname<span class=k>)</span> -j MASQUERADE
</span></span></code></pre></td></tr></table></div></div><p>由于硬件的BUG，还需要在开机脚本里添加一条命令，关闭ipv6的硬件加速，不然速度就会其慢无比</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=nb>echo</span> <span class=m>8</span> <span class=m>0</span> &gt; /sys/kernel/debug/hnat/hnat_setting
</span></span></code></pre></td></tr></table></div></div><p>完成后重启就会发现有ipv6了</p><p>然而，在我使用的过程中发现，开启了ipv6后手机打开app时加载的速度肉眼可见的变慢。一开始以为是DNS的问题，但修改了默认的DNS服务器后还是不行。<del>为了保证使用的体验，目前我还是把nat6给关闭了😭。</del></p><p>已经找到了解决方案😉，见下一节</p><h3 id=配置mosdns><a href=#%e9%85%8d%e7%bd%aemosdns class=header-anchor></a>配置mosdns</h3><p>mosdns作为一款自定义程度很高的DNS转发器，在之前的博文<a class=link href=https://lbqaq.top/p/mydns/ target=_blank rel=noopener>《自建DNS实现分流及广告过滤》</a>就已经使用过了，这里我们需要他来解决ipv6 NAT后的卡顿问题。同时，配置好mosdns后，也可以实现广告过滤，dns防污染的功能。</p><p>安装可以使用<a class=link href=https://github.com/sbwml/luci-app-mosdns target=_blank rel=noopener>luci-app-mosdns</a>这个项目来实现，直接执行它的脚本即可</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>sh -c <span class=s2>&#34;</span><span class=k>$(</span>curl -ksS https://raw.githubusercontent.com/sbwml/luci-app-mosdns/v5/install.sh<span class=k>)</span><span class=s2>&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>和之前的方案一样，我们需要以下项目提供的域名/IP文件：</p><ul><li><a class=link href=https://github.com/Loyalsoldier/v2ray-rules-dat#%e8%a7%84%e5%88%99%e6%96%87%e4%bb%b6%e4%b8%8b%e8%bd%bd%e5%8f%8a%e4%bd%bf%e7%94%a8%e6%96%b9%e5%bc%8f target=_blank rel=noopener>reject-list.txt 和 direct-list.txt</a></li><li><a class=link href=https://github.com/Masaiki/GeoIP2-CN#-%e4%b8%8b%e8%bd%bd%e9%93%be%e6%8e%a5 target=_blank rel=noopener>CN-ip-cidr.txt</a></li><li><a class=link href=https://anti-ad.net/ target=_blank rel=noopener>ad-domains.txt</a>：下载<code>domains.txt</code>并改名</li></ul><p>其实luci-app-mosdns默认提供了一套配置，但是我们需要使用mosdns的优先ipv4的功能，所以只能自己撸配置了。没错，解决ipv6卡顿的最好方式就是不用😥，通过mosdns可以避免操作系统使用优先ipv6的策略。这样既实现了不卡顿，又可以访问纯ipv6网站。</p><p>这套配置可以实现屏蔽广告，国内域名用本地DNS解析，国外域名走远程DNS解析。遇到不在列表中的域名，会查询本地DNS，如果返回的是国外地址，则以远程DNS的结果为准。</p><p>具体的配置如下：</p><details><summary>📃展开代码</summary><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># Powered by luoboQAQ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>log</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>level</span><span class=p>:</span><span class=w> </span><span class=l>warn</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>file</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/tmp/log/mosdns.log&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># API 入口设置</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>api</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>http</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;0.0.0.0:9091&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>plugins</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 国内域名</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>tag</span><span class=p>:</span><span class=w> </span><span class=l>geosite_cn</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>domain_set</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>files</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s2>&#34;/var/mosdns/direct-list.txt&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 国内IP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>tag</span><span class=p>:</span><span class=w> </span><span class=l>geoip_cn</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>ip_set</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>files</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s2>&#34;/var/mosdns/CN-ip-cidr.txt&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 国外域名</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>tag</span><span class=p>:</span><span class=w> </span><span class=l>geosite_no_cn</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>domain_set</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>files</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s2>&#34;/var/mosdns/proxy-list.txt&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 黑名单域名</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>tag</span><span class=p>:</span><span class=w> </span><span class=l>blocklist</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>domain_set</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>files</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s2>&#34;/etc/mosdns/rule/blocklist.txt&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 广告域名</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>tag</span><span class=p>:</span><span class=w> </span><span class=l>adlist</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>domain_set</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>files</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s2>&#34;/var/mosdns/ad-domains.txt&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># PTR黑名单</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>tag</span><span class=p>:</span><span class=w> </span><span class=l>local_ptr</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>domain_set</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>files</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s2>&#34;/etc/mosdns/rule/local-ptr.txt&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 缓存插件</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>tag</span><span class=p>:</span><span class=w> </span><span class=l>cache</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>cache</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>size</span><span class=p>:</span><span class=w> </span><span class=m>10240</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>lazy_cache_ttl</span><span class=p>:</span><span class=w> </span><span class=m>86400</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># 将缓存保存在磁盘</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>dump_file</span><span class=p>:</span><span class=w> </span><span class=l>/tmp/mosdns/cache.dump</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 转发至本地服务器的插件</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>tag</span><span class=p>:</span><span class=w> </span><span class=l>forward_local</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>forward</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>upstreams</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>tag</span><span class=p>:</span><span class=w> </span><span class=l>alidns_dot</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>addr</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;tls://223.5.5.5&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>tag</span><span class=p>:</span><span class=w> </span><span class=l>dnspod_dot</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>addr</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;tls://120.53.53.53&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 转发至远程服务器的插件</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>tag</span><span class=p>:</span><span class=w> </span><span class=l>forward_remote</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>forward</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>upstreams</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c># - tag: easymosdns</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c>#   addr: &#34;https://doh.apad.pro/dns-query&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c>#   bootstrap: &#34;223.5.5.5&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>tag</span><span class=p>:</span><span class=w> </span><span class=l>cloudflare_dot</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>addr</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;tls://1.1.1.1&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 国内解析</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>tag</span><span class=p>:</span><span class=w> </span><span class=l>local_sequence</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>sequence</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>exec</span><span class=p>:</span><span class=w> </span><span class=l>$forward_local</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># fallback 用本地服务器 sequence</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 返回不包含本地 ip 则 reject</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>tag</span><span class=p>:</span><span class=w> </span><span class=l>local_ip_sequence</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>sequence</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>exec</span><span class=p>:</span><span class=w> </span><span class=l>$forward_local</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>matches</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;!resp_ip $geoip_cn&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>exec</span><span class=p>:</span><span class=w> </span><span class=l>drop_resp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># fallback 用远程服务器 sequence</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>tag</span><span class=p>:</span><span class=w> </span><span class=l>remote_sequence</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>sequence</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>exec</span><span class=p>:</span><span class=w> </span><span class=l>$forward_remote</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># fallback插件</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>tag</span><span class=p>:</span><span class=w> </span><span class=l>fallback</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>fallback</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>primary</span><span class=p>:</span><span class=w> </span><span class=l>local_ip_sequence</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>secondary</span><span class=p>:</span><span class=w> </span><span class=l>remote_sequence</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>threshold</span><span class=p>:</span><span class=w> </span><span class=m>500</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>always_standby</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 有响应终止返回</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>tag</span><span class=p>:</span><span class=w> </span><span class=l>has_resp_sequence</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>sequence</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>matches</span><span class=p>:</span><span class=w> </span><span class=l>has_resp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>exec</span><span class=p>:</span><span class=w> </span><span class=l>accept</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 查询国内域名</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>tag</span><span class=p>:</span><span class=w> </span><span class=l>query_is_local_domain</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>sequence</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>matches</span><span class=p>:</span><span class=w> </span><span class=l>qname $geosite_cn</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>exec</span><span class=p>:</span><span class=w> </span><span class=l>$local_sequence</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 查询国外域名</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>tag</span><span class=p>:</span><span class=w> </span><span class=l>query_is_no_local_domain</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>sequence</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>matches</span><span class=p>:</span><span class=w> </span><span class=l>qname $geosite_no_cn</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>exec</span><span class=p>:</span><span class=w> </span><span class=l>$remote_sequence</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 查询拒绝域名</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>tag</span><span class=p>:</span><span class=w> </span><span class=l>query_is_reject_domain</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>sequence</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>matches</span><span class=p>:</span><span class=w> </span><span class=l>qname $blocklist</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>exec</span><span class=p>:</span><span class=w> </span><span class=l>reject 3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>matches</span><span class=p>:</span><span class=w> </span><span class=l>qname $adlist</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>exec</span><span class=p>:</span><span class=w> </span><span class=l>reject 3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>matches</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>qtype 12</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>qname $local_ptr</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>exec</span><span class=p>:</span><span class=w> </span><span class=l>reject 3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>matches</span><span class=p>:</span><span class=w> </span><span class=l>qtype 65</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>exec</span><span class=p>:</span><span class=w> </span><span class=l>reject 3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 主要运行逻辑插件</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>tag</span><span class=p>:</span><span class=w> </span><span class=l>main_sequence</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>sequence</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># 去广告</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>exec</span><span class=p>:</span><span class=w> </span><span class=l>$query_is_reject_domain</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>exec</span><span class=p>:</span><span class=w> </span><span class=l>jump has_resp_sequence</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># ipv4地址优先，避免NAT占用CPU</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>exec</span><span class=p>:</span><span class=w> </span><span class=l>prefer_ipv4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>exec</span><span class=p>:</span><span class=w> </span><span class=l>$cache</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>exec</span><span class=p>:</span><span class=w> </span><span class=l>jump has_resp_sequence</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>exec</span><span class=p>:</span><span class=w> </span><span class=l>$query_is_local_domain</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>exec</span><span class=p>:</span><span class=w> </span><span class=l>jump has_resp_sequence</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>exec</span><span class=p>:</span><span class=w> </span><span class=l>$query_is_no_local_domain</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>exec</span><span class=p>:</span><span class=w> </span><span class=l>jump has_resp_sequence     </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>exec</span><span class=p>:</span><span class=w> </span><span class=l>$fallback</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 启动 udp 服务器。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>tag</span><span class=p>:</span><span class=w> </span><span class=l>udp_server</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>udp_server</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>entry</span><span class=p>:</span><span class=w> </span><span class=l>main_sequence</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>listen</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;:5335&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 启动 tcp 服务器。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>tag</span><span class=p>:</span><span class=w> </span><span class=l>tcp_server</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>tcp_server</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>entry</span><span class=p>:</span><span class=w> </span><span class=l>main_sequence</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>listen</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;:5335&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></details><h3 id=配置wireguard><a href=#%e9%85%8d%e7%bd%aewireguard class=header-anchor></a>配置Wireguard</h3><p>学院的服务器是在内网中的，如果没有连校园网就无法访问。为了随时随地可以访问，我们可以使用Wireguard进行虚拟组网。基于ipv6直接是公网的特点，我们可以很方便的实现这个功能。</p><p>连接路由器，使用命令创建预共享密钥</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># 创建目录存放公钥私钥</span>
</span></span><span class=line><span class=cl>mkdir wg
</span></span><span class=line><span class=cl><span class=c1># 进入文件夹</span>
</span></span><span class=line><span class=cl><span class=nb>cd</span> wg
</span></span><span class=line><span class=cl><span class=c1># 配置创建密钥的权限</span>
</span></span><span class=line><span class=cl><span class=nb>umask</span> <span class=m>077</span>
</span></span><span class=line><span class=cl><span class=c1># 创建预共享密钥</span>
</span></span><span class=line><span class=cl>wg genpsk &gt; sharekey
</span></span><span class=line><span class=cl><span class=c1># 获取密钥复制保存</span>
</span></span><span class=line><span class=cl>cat sharekey
</span></span></code></pre></td></tr></table></div></div><p>之后创建服务端公钥私钥</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># 创建服务端公钥和私钥</span>
</span></span><span class=line><span class=cl>wg genkey <span class=p>|</span> tee server_privatekey <span class=p>|</span> wg pubkey &gt; server_publickey
</span></span><span class=line><span class=cl><span class=c1># 获取服务端私钥复制保存</span>
</span></span><span class=line><span class=cl>cat server_privatekey
</span></span><span class=line><span class=cl><span class=c1># 获取服务端公钥复制保存</span>
</span></span><span class=line><span class=cl>cat server_publickey
</span></span></code></pre></td></tr></table></div></div><p>之后创建客户端的公钥私钥，有多少个就要执行几次 <strong>注意文件的命名</strong>，这里以clinet为例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># 创建客户端公钥和私钥</span>
</span></span><span class=line><span class=cl>wg genkey <span class=p>|</span> tee clinet_privatekey <span class=p>|</span> wg pubkey &gt; clinet_publickey
</span></span><span class=line><span class=cl><span class=c1># 获取客户端私钥复制保存</span>
</span></span><span class=line><span class=cl>cat clinet_privatekey
</span></span><span class=line><span class=cl><span class=c1># 获取客户端公钥复制保存</span>
</span></span><span class=line><span class=cl>cat clinet_publickey
</span></span></code></pre></td></tr></table></div></div><p>之后找到网络——接口——添加新接口，选择协议为<code>WireGuard VPN</code></p><p><img src=/p/ax6000/IMAGE/image-20231021204344135.png width=1042 height=303 srcset="/p/ax6000/IMAGE/image-20231021204344135_hu_27b60ca4f9871526.png 480w, /p/ax6000/IMAGE/image-20231021204344135_hu_e307dcc14126bc3.png 1024w" loading=lazy alt=创建新接口 class=gallery-image data-flex-grow=343 data-flex-basis=825px>
接着修改相应的配置：</p><p>接口基本设置</p><ul><li>私钥 - 上文获取的<code>服务端私钥</code></li><li>监听接口 - 随机一个高位的端口，我这里使用10800</li><li>IP地址 - 这里填一个专用的网段 IP，我选择<code>192.168.100.1/24</code></li></ul><p><strong>Peers</strong>设置</p><p>选择<code>预共享密钥</code> - 添加</p><ul><li>公钥 - 填写上文获取的<code>客户端公钥</code></li><li>允许的 IP - 为此客户端分配的固定 IP，我这里是<code>192.168.100.2/32</code><strong>注意不要冲突</strong></li><li>预共享密钥 - 填写上文获取的<code>预共享密钥</code></li><li>路由允许的 IP - 勾选</li></ul><p>防火墙设置</p><ul><li>选择<code>LAN</code></li></ul><div class="notice notice-info"><div class=notice-title><svg class="icon notice-icon" viewBox="0 0 512 512" fill="hsl(30, 80%, 70%)"><path d="M256 8a248 248 0 100 496 248 248 0 000-496zm0 110a42 42 0 110 84 42 42 0 010-84zm56 254c0 7-5 12-12 12h-88c-7 0-12-5-12-12v-24c0-7 5-12 12-12h12v-64h-12c-7 0-12-5-12-12v-24c0-7 5-12 12-12h64c7 0 12 5 12 12v1e2h12c7 0 12 5 12 12v24z"/></svg></div><p>之前我尝试自己创建一个<code>VPN</code>分区进行管理，但是无法访问路由器上一层内网的地址，估计是防火墙之前的转发规则没设置好，如果不想折腾就选<code>LAN</code>吧</p></div><p>之后在防火墙中的——”打开路由器端口“，将之前设置的WireGuard监听端口的UDP流量放行</p><p>这样就算配置好了。</p><p>客户端的配置文件类似下面这样：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[Interface]
</span></span><span class=line><span class=cl># 对应之前配置的静态地址
</span></span><span class=line><span class=cl>Address = 192.168.100.2/32
</span></span><span class=line><span class=cl># 客户端的私钥
</span></span><span class=line><span class=cl>PrivateKey = ******
</span></span><span class=line><span class=cl># 本地的 DNS 服务器或者公有 DNS 服务器,例如: 114.114.114.114
</span></span><span class=line><span class=cl>#DNS = 192.168.6.1
</span></span><span class=line><span class=cl>[Peer]
</span></span><span class=line><span class=cl># 路由器公钥
</span></span><span class=line><span class=cl>PublicKey = ******
</span></span><span class=line><span class=cl># 设置那些地址走WireGuard，如下设置只用局域网走WireGuard,互联网走本地网络.
</span></span><span class=line><span class=cl>#AllowedIPs = 192.168.6.0/24, 192.168.100.0/24, 192.168.101.0/24
</span></span><span class=line><span class=cl># 全局模式
</span></span><span class=line><span class=cl>AllowedIps = 0.0.0.0/0
</span></span><span class=line><span class=cl># 预共享密钥，同之前所配置
</span></span><span class=line><span class=cl>PresharedKey = ******
</span></span><span class=line><span class=cl># 路由器的ip地址和端口
</span></span><span class=line><span class=cl>Endpoint = 10.134.10.10:10800
</span></span><span class=line><span class=cl># 每隔多少秒检查一次连接
</span></span><span class=line><span class=cl>PersistentKeepalive = 25
</span></span></code></pre></td></tr></table></div></div><h3 id=配置ddns><a href=#%e9%85%8d%e7%bd%aeddns class=header-anchor></a>配置ddns</h3><p>虽然我们拥有了公网ipv6，但这是动态的，所以我们需要通过ddns使其自动对应到域名上。以后使用的时候只需要域名即可，无需记住ip。</p><p>237大佬的固件已经内置了ddns，我的域名是在cloudflare上，所以选择DDNS 服务提供商 [IPv6]为cloudflare.com-v4，域名填写需要ddns的域名，注意这里要用@隔离子域名和根，例如<code>ddns@lbqaq.top</code>，密码填写全局访问密钥。</p><p>在高级设置里，我将IP 地址来源 [IPv6]设置为了<code>URL</code>，这样避免了脚本错误读取ip地址的情况。</p><p>都设置好后，就可以看到域名所对应的地址已经被更新了。</p><h2 id=小结><a href=#%e5%b0%8f%e7%bb%93 class=header-anchor></a>小结</h2><p>Openwrt作为一个开放的系统，可玩性还是很高的，通过装上所需的插件，极大的提高了我的上网体验，只能说：真香~</p><p>（本来是打算介绍我写的校园网连接程序，结果为了这碟醋包了这盘饺子QwQ）</p><h2 id=更新日志><a href=#%e6%9b%b4%e6%96%b0%e6%97%a5%e5%bf%97 class=header-anchor></a>更新日志</h2><ul><li>23.11.22：添加了uboot和mosdns的内容</li></ul><h2 id=参考文献><a href=#%e5%8f%82%e8%80%83%e6%96%87%e7%8c%ae class=header-anchor></a>参考文献</h2><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p><a class=link href=https://www.bilibili.com/video/BV1Co4y1F7wM/ target=_blank rel=noopener>红米AX6000完美刷机 | 刷机无风险 小白适用</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p><a class=link href=https://www.right.com.cn/forum/thread-8265832-1-2.html target=_blank rel=noopener>红米AX6000刷hanwckf大佬的不死uboot+刷回官方固件+TTL使用+编程器救砖教程</a>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p><a class=link href=https://zhuanlan.zhihu.com/p/492774540 target=_blank rel=noopener>校园网环境下Openwrt配置ipv6教程——以nat6为例</a>&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></section><footer class=article-footer><section class=article-tags><a href=/tags/%E6%95%99%E7%A8%8B/>教程</a>
<a href=/tags/%E8%B7%AF%E7%94%B1%E5%99%A8/>路由器</a>
<a href=/tags/openwrt/>Openwrt</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section><section class=article-lastmod><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<span>最后更新于 2023-11-22 13:24:00</span></section></footer><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css crossorigin=anonymous><script src=https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/auto-render.min.js crossorigin=anonymous defer></script><script>window.addEventListener("DOMContentLoaded",()=>{const e=document.querySelector(".main-article");renderMathInElement(e,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}],ignoredClasses:["gist"]})})</script></article><aside class=related-content--wrapper><h2 class=section-title>相关文章</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/p/wireguard-ipv6/><div class=article-image><img src=/p/wireguard-ipv6/104589070.5e41b10ddb272bb589ecbfcf88b93c1f.webp width=1803 height=1125 loading=lazy alt="Featured image of post 使用WireGuard+ipv6进行异地组网" data-key=wireguard-ipv6 data-hash="md5-XkGxDdsnK7WJ7L/PiLk8Hw=="></div><div class=article-details><h2 class=article-title>使用WireGuard+ipv6进行异地组网</h2></div></a></article><article class=has-image><a href=/p/dns-shunt/><div class=article-image><img src=/p/dns-shunt/115597971.cb1d0371fe7521df639b69ebf4426b23.webp width=2000 height=1400 loading=lazy alt="Featured image of post 基于DNS的分流方案" data-key=dns-shunt data-hash="md5-yx0Dcf51Id9jm2nr9EJrIw=="></div><div class=article-details><h2 class=article-title>基于DNS的分流方案</h2></div></a></article><article class=has-image><a href=/p/%E4%B8%80%E6%AD%A5%E5%88%B0%E4%BD%8D%E8%87%AA%E5%8A%A8%E7%94%B3%E8%AF%B7ssl%E8%AF%81%E4%B9%A6/><div class=article-image><img src=/p/%E4%B8%80%E6%AD%A5%E5%88%B0%E4%BD%8D%E8%87%AA%E5%8A%A8%E7%94%B3%E8%AF%B7ssl%E8%AF%81%E4%B9%A6/99528942.cc2e0262f9453b8f27fe2926714d30d6.webp width=1993 height=1500 loading=lazy alt="Featured image of post 一步到位，自动申请SSL证书" data-hash="md5-zC4CYvlFO48n/ikmcU0w1g=="></div><div class=article-details><h2 class=article-title>一步到位，自动申请SSL证书</h2></div></a></article><article class=has-image><a href=/p/mydns/><div class=article-image><img src=/p/mydns/100669875.996c5643dbba4e97e3b68a917d181fb2.webp width=2008 height=1080 loading=lazy alt="Featured image of post 自建DNS实现分流及广告过滤" data-key=mydns data-hash="md5-mWxWQ9u6TpfjtoqRfRgfsg=="></div><div class=article-details><h2 class=article-title>自建DNS实现分流及广告过滤</h2></div></a></article></div></div></aside><link href=//unpkg.com/@waline/client@v3/dist/waline.css rel=stylesheet><div id=waline class=waline-container></div><style>.waline-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding);--waline-font-size:var(--article-font-size)}.waline-container .wl-count{color:var(--card-text-color-main)}</style><script type=module>
    import { init } from 'https://unpkg.com/@waline/client@v3/dist/waline.js';

    setTimeout(function () {
        
        init({"dark":"html[data-scheme=\"dark\"]","el":"#waline","emoji":["https://unpkg.com/@waline/emojis@1.2.0/weibo"],"lang":"zh-CN","locale":{"admin":"Admin","placeholder":null},"requiredMeta":["name","email","url"],"serverURL":"https://waline.lbqaq.top/"});
    }, 300);


</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2025 luoboQAQ</section><section class=powerby><a href=https://beian.miit.gov.cn>苏ICP备2021037116号</a><br>使用 <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> 构建<br>主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.30.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://npm.elemecdn.com/node-vibrant@latest/dist/vibrant.min.js crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e);const t=document.createElement("link");t.href="https://cdn.jsdelivr.net/npm/@callmebill/lxgw-wenkai-web@latest/style.css",t.type="text/css",t.rel="stylesheet",document.head.appendChild(t)})()</script></body></html>